@using Microsoft.AspNetCore.Identity
@inject UserManager<Telemed.Models.ApplicationUser> UserManager
@using Telemed.Models
@model List<Prescription>

@{
    ViewData["Title"] = "Prescriptions";
    bool isDoctor = User.IsInRole("Doctor");
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">
            <i class="bi bi-file-medical"></i> Prescriptions
        </h2>
        @if (isDoctor)
        {
            <a asp-action="Create" class="btn btn-primary shadow-sm">
                <i class="bi bi-plus-circle"></i> Create Prescription
            </a>
        }
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No prescriptions found.
        </div>
    }
    else
    {
        <div class="table-responsive shadow-sm rounded-4 border">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Patient</th>
                        <th>Doctor</th>
                        <th>Medicine</th>
                        <th>Dosage</th>
                        <th>Duration</th>
                        <th>Date</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.PrescriptionId</td>
                            <td>@item.Appointment?.Patient?.User?.FullName</td>
                            <td>@item.Appointment?.Doctor?.User?.FullName</td>
                            <td>@item.MedicineName</td>
                            <td>@item.Dosage</td>
                            <td>@item.Duration</td>
                            <td>@item.CreatedAt.ToString("yyyy-MM-dd")</td>
                            <td class="text-center">
                                <a asp-action="Pdf" asp-route-id="@item.PrescriptionId" class="btn btn-sm btn-outline-success">
                                    <i class="bi bi-download"></i> PDF
                                </a>

                                @if (!string.IsNullOrEmpty(item.FilePath))
                                {
                                    <a href="~@item.FilePath" class="btn btn-sm btn-outline-primary ms-1" download>
                                        <i class="bi bi-file-earmark-arrow-down"></i> File
                                    </a>
                                }

                                @if (isDoctor)
                                {
                                    <button class="btn btn-sm btn-outline-warning ms-1"
                                            data-bs-toggle="modal" data-bs-target="#editModal"
                                            data-id="@item.PrescriptionId"
                                            data-medicine="@item.MedicineName"
                                            data-dosage="@item.Dosage"
                                            data-duration="@item.Duration"
                                            data-notes="@item.Notes">
                                        <i class="bi bi-pencil-square"></i> Edit
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editForm" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title text-primary"><i class="bi bi-pencil-square"></i> Edit Prescription</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="prescriptionId" name="id" />
                    <div class="mb-3">
                        <label class="form-label">Medicine Name</label>
                        <input type="text" class="form-control" id="medicineName" name="MedicineName" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dosage</label>
                        <input type="text" class="form-control" id="dosage" name="Dosage" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Duration</label>
                        <input type="text" class="form-control" id="duration" name="Duration" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="Notes" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Replace File (optional)</label>
                        <input type="file" class="form-control" name="file" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var editModal = document.getElementById('editModal');
        editModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var id = button.getAttribute('data-id');
            var medicine = button.getAttribute('data-medicine');
            var dosage = button.getAttribute('data-dosage');
            var duration = button.getAttribute('data-duration');
            var notes = button.getAttribute('data-notes');

            document.getElementById('prescriptionId').value = id;
            document.getElementById('medicineName').value = medicine;
            document.getElementById('dosage').value = dosage;
            document.getElementById('duration').value = duration;
            document.getElementById('notes').value = notes;
        });

        document.getElementById('editForm').addEventListener('submit', function (e) {
            e.preventDefault();
            var form = e.target;
            var id = document.getElementById('prescriptionId').value;
            var data = new FormData(form);

            fetch(`/Prescriptions/UpdatePrescription/${id}`, {
                method: 'POST',
                body: data
            })
            .then(res => res.json())
            .then(res => {
                if (res.success) {
                    location.reload();
                } else {
                    alert('Failed to update prescription.');
                }
            })
            .catch(err => console.error(err));
        });
    </script>
}
