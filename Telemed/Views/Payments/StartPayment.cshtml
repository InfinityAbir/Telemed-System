@model Telemed.Models.Payment

@{
    ViewData["Title"] = "Payment";
    var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var isPatientOwner = User.IsInRole("Patient") && Model.Appointment.Patient.UserId == userId;
}

<div class="container mt-5" style="max-width: 600px;">
    <div class="card shadow-lg rounded-4 p-4">
        <h2 class="text-center mb-4">Complete Your Payment</h2>

        <div class="mb-3">
            <strong>Doctor:</strong> @Model.Appointment.Doctor.User.FullName
        </div>
        <div class="mb-3">
            <strong>Specialization:</strong> @Model.Appointment.Doctor.Specialization
        </div>
        <div class="mb-3">
            <strong>Appointment Date:</strong> @Model.Appointment.ScheduledAt.ToString("dd MMM yyyy HH:mm")
        </div>
        <div class="mb-3">
            <strong>Consultation Fee:</strong> ৳@Model.Amount
        </div>
        <div class="mb-3">
            <strong>Status:</strong>
            @if (Model.Status == Telemed.Models.PaymentStatus.Paid)
            {
                <span class="badge bg-success">Paid</span>
            }
            else
            {
                <span class="badge bg-warning text-dark">Pending</span>
            }
        </div>

        @* Only allow the patient who owns this appointment to pay *@
        @if (isPatientOwner && Model.Status == Telemed.Models.PaymentStatus.Pending)
        {
            <form asp-action="ProcessPayment" method="post">
                <input type="hidden" asp-for="PaymentId" />
                <button type="submit" class="btn btn-primary w-100 btn-lg rounded-pill shadow-sm">
                    Pay Now
                </button>
            </form>
        }
        else if (Model.Status == Telemed.Models.PaymentStatus.Paid)
        {
            <div class="alert alert-success text-center mt-3">
                Payment completed successfully!
            </div>
        }
        else
        {
            <div class="alert alert-secondary text-center mt-3">
                You cannot process this payment.
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.querySelector("form")?.addEventListener("submit", function(e) {
            if (!confirm("Are you sure you want to pay now?")) {
                e.preventDefault();
            }
        });
    </script>
}
