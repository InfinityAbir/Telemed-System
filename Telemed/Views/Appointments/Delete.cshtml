@model Telemed.Models.Appointment
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Cancel or Delete Appointment";
    var user = await UserManager.GetUserAsync(User);
    bool isDoctor = User.IsInRole("Doctor");
    bool isAdmin = User.IsInRole("Admin");
    bool isPatient = User.IsInRole("Patient");
    bool canCancel = Model.ScheduledAt > DateTime.Now;
}

<div class="container mt-5">
    <div class="card shadow-lg border-0 rounded-4">
        <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                @(isPatient ? "Cancel Appointment" : "Delete Appointment")
            </h4>
            <a asp-action="Index" class="btn btn-light btn-sm">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>

        <div class="card-body">
            <p class="text-muted">
                @(isPatient ? "You can cancel this appointment only if the time has not passed yet."
                                : "This action will permanently remove the appointment from the system.")
            </p>

            <dl class="row mb-4">
                <dt class="col-sm-3 fw-bold">Doctor</dt>
                <dd class="col-sm-9">@Model.Doctor?.User?.FullName</dd>

                <dt class="col-sm-3 fw-bold">Patient</dt>
                <dd class="col-sm-9">@Model.Patient?.User?.FullName</dd>

                <dt class="col-sm-3 fw-bold">Scheduled At</dt>
                <dd class="col-sm-9">@Model.ScheduledAt.ToString("f")</dd>

                <dt class="col-sm-3 fw-bold">Status</dt>
                <dd class="col-sm-9">
                    <span class="badge
                        @(Model.Status == AppointmentStatus.PendingPayment ? "bg-warning text-dark" :
                                                    Model.Status == AppointmentStatus.Completed ? "bg-success" : "bg-secondary")">
                        @Model.Status
                    </span>
                </dd>

                @if (!string.IsNullOrEmpty(Model.PatientNote))
                {
                    <dt class="col-sm-3 fw-bold">Patient Note</dt>
                    <dd class="col-sm-9">@Model.PatientNote</dd>
                }

                @if (!string.IsNullOrEmpty(Model.DoctorNote))
                {
                    <dt class="col-sm-3 fw-bold">Doctor Note</dt>
                    <dd class="col-sm-9">@Model.DoctorNote</dd>
                }
            </dl>

            @if (isPatient && !canCancel)
            {
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    You can no longer cancel this appointment because it’s already in the past.
                </div>
                <a asp-action="Index" class="btn btn-secondary">Back to List</a>
            }
            else
            {
                <form asp-action="DeleteConfirmed" method="post">
                    <input type="hidden" asp-for="AppointmentId" />
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i>
                        @(isPatient ? "Cancel Appointment" : "Delete Appointment")
                    </button>
                    <a asp-action="Index" class="btn btn-outline-secondary ms-2">Back to List</a>
                </form>
            }
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
}
