@model Telemed.ViewModels.AppointmentCreateViewModel
@{
    ViewData["Title"] = "Book Appointment";
    var doctors = ViewBag.Doctors as IEnumerable<dynamic>;
}

<div class="container mt-4">
    <h2>Book an Appointment</h2>
    <hr />

    <form id="appointmentForm" asp-action="Create" method="post">
        @Html.AntiForgeryToken()

        <div class="mb-3">
            <label for="DoctorId" class="form-label">Select Doctor</label>
            <select id="DoctorId" name="DoctorId" class="form-select" required>
                <option value="">-- Choose a Doctor --</option>
                @foreach (var doc in doctors)
                {
                    <option value="@doc.DoctorId" data-fee="@doc.ConsultationFee">
                        @doc.FullName
                    </option>
                }
            </select>
        </div>

        <div class="mb-3">
            <label for="consultationFee" class="form-label">Consultation Fee</label>
            <input type="text" id="consultationFee" class="form-control" value="0 BDT" readonly />
        </div>

        <div class="mb-3">
            <label for="appointmentDate" class="form-label">Select Date</label>
            <input type="date" id="appointmentDate" class="form-control" required />
        </div>

        <div class="mb-3">
            <label for="timeSlot" class="form-label">Available Time Slots</label>
            <select id="timeSlot" class="form-select" required>
                <option value="">-- Select a time slot --</option>
            </select>
        </div>

        <input type="hidden" id="ScheduledAt" name="ScheduledAt" />

        <div class="mb-3">
            <label asp-for="PatientNote" class="form-label"></label>
            <textarea asp-for="PatientNote" class="form-control" rows="3"></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Book Appointment</button>
    </form>

    <div id="responseMessage" class="mt-3"></div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const doctorSelect = document.getElementById("DoctorId");
        const dateInput = document.getElementById("appointmentDate");
        const slotSelect = document.getElementById("timeSlot");
        const scheduledAtHidden = document.getElementById("ScheduledAt");
        const form = document.getElementById("appointmentForm");
        const msgDiv = document.getElementById("responseMessage");
        const feeInput = document.getElementById("consultationFee");

        async function fetchSlots() {
            const doctorId = doctorSelect.value;
            const date = dateInput.value;

            if (!doctorId || !date) {
                slotSelect.innerHTML = `<option value="">-- Select a time slot --</option>`;
                feeInput.value = "0 BDT";
                return;
            }

            const response = await fetch(`/Appointments/GetAvailableSlots?doctorId=${doctorId}&date=${date}`);
            const data = await response.json();

            slotSelect.innerHTML = "";
            if (data.success) {
                slotSelect.innerHTML = `<option value="">-- Select a time slot --</option>`;
                data.slots.forEach(slot => {
                    slotSelect.innerHTML += `<option value="${slot}">${slot}</option>`;
                });

                // Update consultation fee dynamically
                feeInput.value = data.fee + " BDT";
            } else {
                slotSelect.innerHTML = `<option value="">${data.message}</option>`;
                feeInput.value = "0 BDT";
            }
        }

        doctorSelect.addEventListener("change", fetchSlots);
        dateInput.addEventListener("change", fetchSlots);

        slotSelect.addEventListener("change", () => {
            const date = dateInput.value;
            const time = slotSelect.value;
            if (date && time) {
                scheduledAtHidden.value = `${date}T${time}`;
            }
        });

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = new FormData(form);
            const response = await fetch(form.action, {
                method: "POST",
                body: formData
            });
            const data = await response.json();

            msgDiv.textContent = data.message;
            msgDiv.className = data.success ? "text-success" : "text-danger";

            if (data.success) {
                form.reset();
                slotSelect.innerHTML = `<option value="">-- Select a time slot --</option>`;
                feeInput.value = "0 BDT";
            }
        });
    </script>
}
